name: Dev/Test CI

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:

env:
  AWS_REGION: ap-south-1
  ECR_REPO: app
  PYTHON_VERSION: "3.11"

jobs:
  ci:
    name: CI Train & Dev Docker
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install DVC
        run: pip install "dvc[s3]==3.66.1"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Detect model folders
        id: detect-models
        run: |
          MODELS=$(find . -maxdepth 1 -type d ! -name ".git" ! -name ".github" \
                  -exec test -f "{}/Dockerfile" \; -print | sed 's|^\./||')
          echo "models=$MODELS" >> $GITHUB_OUTPUT

      - name: Run training and build dev Docker images
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          ECR_URI=${{ steps.login-ecr.outputs.registry }}

          for model in ${{ steps.detect-models.outputs.models }}; do
            echo "=== Training $model ==="

            # Install model-specific requirements
            python -m pip install --upgrade pip
            pip install -r $model/requirements.txt

            # Pull data from DVC/S3
            if [ -f "$model/data/iris.csv.dvc" ]; then
              pushd $model
              dvc pull
              popd
            fi

            # Run training inside the model folder
            pushd $model
            python train.py

            # Ensure artifact exists
            if [ ! -f artifacts/model.pkl ]; then
              echo "❌ model.pkl missing for $model"
              exit 1
            fi
            popd

            # Build and push Docker image
            TAG="${model}-dev-${SHORT_SHA}"
            docker build -t $ECR_URI/${{ env.ECR_REPO }}:$TAG ./$model
            docker push $ECR_URI/${{ env.ECR_REPO }}:$TAG
            echo "✅ Pushed dev image: $ECR_URI/${{ env.ECR_REPO }}:$TAG"
          done